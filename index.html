<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Pro V12 - Fix Total & Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; transform: scale(0.95); }
        .modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg leading-none uppercase">BAR GESTION <span class="text-yellow-400 text-xs ml-1">V12</span></h1>
                <div id="version-info" class="text-[9px] text-slate-400 mt-1 font-mono">
                    MAJ: 26/01/2026 19:56
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="ouvrirAdmin()" class="bg-slate-700 p-2 rounded-lg">‚öôÔ∏è</button>
                <button onclick="ouvrirRapport()" class="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold uppercase">üìä Rapport</button>
            </div>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-48">
        <div class="grid grid-cols-3 gap-2 mb-6" id="grid-tables"></div>
        <div id="section-menu" class="hidden">
            <h2 id="title-commande" class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-600 pl-3 uppercase text-sm">Menu</h2>
            <div id="container-articles" class="grid gap-3"></div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto">
            <div id="panier-liste" class="mb-4 text-sm font-bold max-h-32 overflow-y-auto bg-gray-50 p-3 rounded-xl"></div>
            <div class="flex justify-between items-center mb-4 border-t pt-2">
                <span class="text-gray-500 font-bold uppercase text-xs font-mono">Total Commande :</span>
                <span id="total-prix" class="text-3xl font-black text-red-600">0 F</span>
            </div>
            <div class="flex gap-2">
                <button onclick="viderCommande()" class="bg-gray-100 text-gray-400 px-4 py-4 rounded-xl font-bold uppercase text-[10px]">Vider</button>
                <button onclick="encaisserEtImprimer()" class="flex-1 bg-green-600 text-white font-black py-4 rounded-xl shadow-lg text-lg">üñ®Ô∏è IMPRIMER TICKET</button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4 text-slate-800">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h2 class="text-xl font-black mb-4 flex justify-between">R√©glages <button onclick="fermerAdmin()" class="text-gray-400">&times;</button></h2>
            <div class="space-y-4 mb-6">
                <input id="new-nom" type="text" placeholder="Nom produit" class="w-full border p-3 rounded-xl outline-blue-500">
                <input id="new-prix" type="number" placeholder="Prix" class="w-full border p-3 rounded-xl outline-blue-500">
                <button onclick="sauvegarderProduit()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl italic">Sauvegarder</button>
            </div>
            <div id="admin-liste" class="max-h-48 overflow-y-auto space-y-2 border-t pt-4"></div>
        </div>
    </div>

    <script>
        let tableActuelle = null;
        let panier = {}; 
        let charPrinter = null;
        let MENU = JSON.parse(localStorage.getItem('bar_menu_custom')) || [{ nom: "Guiness", prix: 1000 }, { nom: "Bock 66", prix: 600 }];
        let ventesJour = JSON.parse(localStorage.getItem('ventes_bar_v12')) || [];

        function initApp() {
            const grid = document.getElementById('grid-tables');
            grid.innerHTML = "";
            for(let i=1; i<=11; i++) {
                grid.innerHTML += `<button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-3 rounded-xl font-bold text-slate-500 text-sm">Table ${i}</button>`;
            }
            afficherMenu();
        }

        function afficherMenu() {
            const container = document.getElementById('container-articles');
            const adminListe = document.getElementById('admin-liste');
            container.innerHTML = ""; adminListe.innerHTML = "";
            MENU.sort((a,b) => a.nom.localeCompare(b.nom)).forEach((item, index) => {
                container.innerHTML += `<button onclick="ajouterItem('${item.nom}', ${item.prix})" class="w-full bg-white border-2 p-4 rounded-xl flex justify-between items-center shadow-sm active:bg-blue-50"><span class="font-bold text-slate-700">${item.nom}</span><span class="text-blue-700 font-black">${item.prix}F</span></button>`;
                adminListe.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded-lg"><span>${item.nom} (${item.prix}F)</span><button onclick="supprimerProduit(${index})" class="text-red-500 font-bold uppercase">X</button></div>`;
            });
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
        }

        function ajouterItem(nom, prix) {
            if (panier[nom]) { panier[nom].qte += 1; } 
            else { panier[nom] = { prix: prix, qte: 1 }; }
            majPanierUI();
        }

        function majPanierUI() {
            const liste = document.getElementById('panier-liste');
            liste.innerHTML = "";
            let total = 0;
            for (let [nom, data] of Object.entries(panier)) {
                let sousTotal = data.prix * data.qte;
                total += sousTotal;
                liste.innerHTML += `<div class="flex justify-between py-1 border-b border-dashed"><span>${nom} x${data.qte}</span><span>${sousTotal} F</span></div>`;
            }
            document.getElementById('total-prix').innerText = total + " F";
            document.getElementById('footer-panier').classList.toggle('translate-y-full', total === 0);
        }

        function viderCommande() { panier = {}; majPanierUI(); }
        function ouvrirAdmin() { document.getElementById('modal-admin').classList.remove('hidden'); }
        function fermerAdmin() { document.getElementById('modal-admin').classList.add('hidden'); }

        function sauvegarderProduit() {
            const nom = document.getElementById('new-nom').value;
            const prix = parseInt(document.getElementById('new-prix').value);
            if(!nom || !prix) return;
            MENU.push({nom, prix});
            localStorage.setItem('bar_menu_custom', JSON.stringify(MENU));
            document.getElementById('new-nom').value = ""; document.getElementById('new-prix').value = "";
            afficherMenu();
        }

        function supprimerProduit(i) {
            MENU.splice(i, 1);
            localStorage.setItem('bar_menu_custom', JSON.stringify(MENU));
            afficherMenu();
        }

        async function encaisserEtImprimer() {
            try {
                if (!charPrinter) {
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb']
                    });
                    const server = await device.gatt.connect();
                    const services = await server.getPrimaryServices();
                    charPrinter = (await services[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
                }

                const enc = new TextEncoder();
                const init = new Uint8Array([0x1B, 0x40]);
                const boldOn = new Uint8Array([0x1B, 0x45, 0x01]);
                
                // HEADER ET CORPS
                let txtHeader = "\n      *** RECU CLIENT ***\n";
                txtHeader += "DATE: " + new Date().toLocaleTimeString() + "  TABLE: " + tableActuelle + "\n";
                txtHeader += "--------------------------------\n";
                
                let grandTotal = 0;
                let txtCorps = "";
                for (let [nom, data] of Object.entries(panier)) {
                    let st = data.prix * data.qte;
                    grandTotal += st;
                    let l1 = nom + " x" + data.qte;
                    let l2 = st + "F";
                    let dots = ".".repeat(Math.max(1, 32 - l1.length - l2.length));
                    txtCorps += l1 + dots + l2 + "\n";
                    for(let i=0; i<data.qte; i++) ventesJour.push({nom, prix: data.prix});
                }
                
                // TOTAL (S√âPAR√â POUR √äTRE S√õR QU'IL SORTE)
                let txtTotal = "--------------------------------\n";
                let label = "TOTAL A PAYER:";
                let val = grandTotal + " FCFA";
                let spaces = " ".repeat(Math.max(1, 32 - label.length - val.length));
                txtTotal += label + spaces + val + "\n";
                txtTotal += "--------------------------------\n";
                txtTotal += "\n\n\n\n\n\n";

                // ENVOI S√âQUENTIEL
                await charPrinter.writeValue(init);
                await charPrinter.writeValue(boldOn);
                await charPrinter.writeValue(enc.encode(txtHeader + txtCorps));
                // Pause de 50ms pour laisser l'imprimante respirer avant le total
                await new Promise(r => setTimeout(r, 50));
                await charPrinter.writeValue(enc.encode(txtTotal));
                
                localStorage.setItem('ventes_bar_v12', JSON.stringify(ventesJour));
                viderCommande();
            } catch (e) { charPrinter = null; alert("Erreur: " + e); }
        }

        function ouvrirRapport() {
            let total = 0; ventesJour.forEach(v => total += v.prix);
            alert("TOTAL RECETTE: " + total + " F");
        }
        initApp();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Pro V11 - Fix Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; transform: scale(0.95); }
        .modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        #panier-liste { font-family: monospace; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="font-bold text-lg leading-none uppercase">Bar Gestion</h1>
                <div id="status" class="text-[10px] text-green-400 font-bold uppercase italic font-mono">Imprimante OK</div>
            </div>
            <div class="flex gap-2">
                <button onclick="ouvrirAdmin()" class="bg-slate-700 p-2 rounded-lg">‚öôÔ∏è</button>
                <button onclick="ouvrirRapport()" class="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold uppercase">üìä Rapport</button>
            </div>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-48">
        <div class="grid grid-cols-3 gap-2 mb-6" id="grid-tables"></div>
        <div id="section-menu" class="hidden">
            <h2 id="title-commande" class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-600 pl-3 uppercase text-sm">Menu</h2>
            <div id="container-articles" class="grid gap-3"></div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto text-slate-800">
            <div id="panier-liste" class="mb-4 text-sm font-bold max-h-32 overflow-y-auto bg-gray-50 p-3 rounded-xl border border-gray-200"></div>
            <div class="flex justify-between items-center mb-4 border-t pt-2">
                <span class="text-gray-500 font-bold uppercase text-xs">A payer :</span>
                <span id="total-prix" class="text-3xl font-black text-red-600">0 F</span>
            </div>
            <div class="flex gap-2">
                <button onclick="viderCommande()" class="bg-gray-100 text-gray-400 px-4 py-4 rounded-xl font-bold uppercase text-[10px]">Vider</button>
                <button onclick="encaisserEtImprimer()" class="flex-1 bg-green-600 text-white font-black py-4 rounded-xl shadow-lg text-lg">üñ®Ô∏è IMPRIMER LE RE√áU</button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h2 class="text-xl font-black mb-4 flex justify-between">Configuration <button onclick="fermerAdmin()" class="text-gray-400">&times;</button></h2>
            <div class="space-y-4 mb-6">
                <input id="new-nom" type="text" placeholder="Nom du produit" class="w-full border p-3 rounded-xl outline-blue-500">
                <input id="new-prix" type="number" placeholder="Prix de vente" class="w-full border p-3 rounded-xl outline-blue-500">
                <button onclick="sauvegarderProduit()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Ajouter</button>
            </div>
            <div id="admin-liste" class="max-h-48 overflow-y-auto space-y-2 border-t pt-4"></div>
        </div>
    </div>

    <script>
        let tableActuelle = null;
        let panier = {}; 
        let charPrinter = null;
        let MENU = JSON.parse(localStorage.getItem('bar_menu_custom')) || [{ nom: "Guiness", prix: 1000 }, { nom: "Bock 66", prix: 600 }];
        let ventesJour = JSON.parse(localStorage.getItem('ventes_bar_v11')) || [];

        function initApp() {
            const grid = document.getElementById('grid-tables');
            grid.innerHTML = "";
            for(let i=1; i<=11; i++) {
                grid.innerHTML += `<button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-3 rounded-xl font-bold text-slate-500 text-sm">Table ${i}</button>`;
            }
            afficherMenu();
        }

        function afficherMenu() {
            const container = document.getElementById('container-articles');
            const adminListe = document.getElementById('admin-liste');
            container.innerHTML = ""; adminListe.innerHTML = "";
            MENU.sort((a,b) => a.nom.localeCompare(b.nom)).forEach((item, index) => {
                container.innerHTML += `<button onclick="ajouterItem('${item.nom}', ${item.prix})" class="w-full bg-white border-2 p-4 rounded-xl flex justify-between items-center shadow-sm active:bg-blue-50"><span class="font-bold text-slate-700">${item.nom}</span><span class="text-blue-700 font-black">${item.prix}F</span></button>`;
                adminListe.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded-lg"><span>${item.nom} (${item.prix}F)</span><button onclick="supprimerProduit(${index})" class="text-red-500 font-bold uppercase">X</button></div>`;
            });
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
        }

        function ajouterItem(nom, prix) {
            if (panier[nom]) { panier[nom].qte += 1; } 
            else { panier[nom] = { prix: prix, qte: 1 }; }
            majPanierUI();
        }

        function majPanierUI() {
            const liste = document.getElementById('panier-liste');
            liste.innerHTML = "";
            let total = 0;
            for (let [nom, data] of Object.entries(panier)) {
                let sousTotal = data.prix * data.qte;
                total += sousTotal;
                liste.innerHTML += `<div class="flex justify-between py-1 border-b border-dashed"><span>${nom} x${data.qte}</span><span>${sousTotal} F</span></div>`;
            }
            document.getElementById('total-prix').innerText = total + " F";
            document.getElementById('footer-panier').classList.toggle('translate-y-full', total === 0);
        }

        function viderCommande() { panier = {}; majPanierUI(); }
        function ouvrirAdmin() { document.getElementById('modal-admin').classList.remove('hidden'); }
        function fermerAdmin() { document.getElementById('modal-admin').classList.add('hidden'); }
        function sauvegarderProduit() {
            const nom = document.getElementById('new-nom').value;
            const prix = parseInt(document.getElementById('new-prix').value);
            if(!nom || !prix) return;
            MENU.push({nom, prix});
            localStorage.setItem('bar_menu_custom', JSON.stringify(MENU));
            document.getElementById('new-nom').value = ""; document.getElementById('new-prix').value = "";
            afficherMenu();
        }
        function supprimerProduit(i) {
            MENU.splice(i, 1);
            localStorage.setItem('bar_menu_custom', JSON.stringify(MENU));
            afficherMenu();
        }

        async function encaisserEtImprimer() {
            try {
                if (!charPrinter) {
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb']
                    });
                    const server = await device.gatt.connect();
                    const services = await server.getPrimaryServices();
                    charPrinter = (await services[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
                }

                const enc = new TextEncoder();
                const init = new Uint8Array([0x1B, 0x40]);
                const boldOn = new Uint8Array([0x1B, 0x45, 0x01]);

                let header = "\n      *** RECU CLIENT ***\n";
                header += "DATE: " + new Date().toLocaleTimeString() + "  TABLE: " + tableActuelle + "\n";
                header += "--------------------------------\n";
                
                let corps = "";
                let grandTotal = 0;
                for (let [nom, data] of Object.entries(panier)) {
                    let st = data.prix * data.qte;
                    grandTotal += st;
                    let l1 = nom + " x" + data.qte;
                    let l2 = st + "F";
                    let dots = ".".repeat(Math.max(1, 32 - l1.length - l2.length));
                    corps += l1 + dots + l2 + "\n";
                    for(let i=0; i<data.qte; i++) ventesJour.push({nom, prix: data.prix});
                }
                
                let footer = "--------------------------------\n";
                let label = "TOTAL A PAYER:";
                let val = grandTotal + " FCFA";
                let spaces = " ".repeat(Math.max(1, 32 - label.length - val.length));
                footer += label + spaces + val + "\n";
                footer += "--------------------------------\n";
                footer += "\n\n\n\n\n"; // Beaucoup de sauts de ligne pour d√©gager le total

                await charPrinter.writeValue(init);
                await charPrinter.writeValue(boldOn);
                // On envoie le texte complet
                await charPrinter.writeValue(enc.encode(header + corps + footer));
                
                localStorage.setItem('ventes_bar_v11', JSON.stringify(ventesJour));
                viderCommande();
            } catch (e) { charPrinter = null; alert("Erreur: " + e); }
        }

        function ouvrirRapport() {
            let total = 0; ventesJour.forEach(v => total += v.prix);
            alert("CAISSE JOUR: " + total + " F");
        }
        initApp();
    </script>
</body>
</html>

