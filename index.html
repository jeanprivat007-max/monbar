<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Pro V22 - Gestion Serveurs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; transform: scale(0.95); }
        .modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg leading-none uppercase">BAR EQUIPE <span class="text-yellow-400 text-xs ml-1">V22</span></h1>
                <div id="version-info" class="text-[9px] text-slate-400 mt-1 font-mono uppercase">Affectation Serveurs Active</div>
            </div>
            <div class="flex gap-2">
                <button onclick="ouvrirAdmin()" class="bg-slate-700 p-2 rounded-lg text-sm font-bold">‚öôÔ∏è STAFF/STOCK</button>
                <button onclick="ouvrirRapport()" class="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold uppercase">üìä CAISSE</button>
            </div>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-48">
        <div class="grid grid-cols-3 gap-2 mb-6" id="grid-tables"></div>
        
        <div id="section-menu" class="hidden">
            <div class="bg-blue-600 text-white p-2 rounded-lg mb-4 text-xs font-bold flex justify-between">
                <span id="label-serveur-table">Serveur : --</span>
                <span id="label-num-table">Table : --</span>
            </div>
            <div class="relative mb-4">
                <input type="text" id="filtre-produit" onkeyup="filtrerMenu()" placeholder="Rechercher produit..." 
                    class="w-full p-4 pl-12 rounded-2xl border-2 border-blue-100 shadow-sm outline-none">
                <span class="absolute left-4 top-4 text-gray-400">üîç</span>
            </div>
            <div id="container-articles" class="grid gap-3"></div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto">
            <div id="panier-liste" class="mb-4 text-sm font-bold max-h-32 overflow-y-auto bg-gray-50 p-3 rounded-xl"></div>
            <div class="flex justify-between items-center mb-4 border-t pt-2">
                <span class="text-gray-500 font-bold uppercase text-xs">Total :</span>
                <span id="total-prix" class="text-3xl font-black text-red-600">0 F</span>
            </div>
            <button id="btn-encaisser" onclick="encaisserEtImprimer()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg text-lg">üñ®Ô∏è VALIDER VENTE</button>
        </div>
    </div>

    <div id="modal-admin" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black italic text-blue-800">Gestion DG</h2>
                <button onclick="fermerAdmin()" class="text-2xl text-gray-400">&times;</button>
            </div>

            <div class="mb-6 p-4 bg-orange-50 rounded-2xl border border-orange-100">
                <h3 class="text-xs font-black text-orange-700 uppercase mb-3">üë• Staff & Affectation</h3>
                <div class="space-y-3">
                    <input id="new-serveur" type="text" placeholder="Nom nouveau serveur" class="w-full p-2 border rounded-lg">
                    <button onclick="ajouterServeur()" class="w-full bg-orange-500 text-white font-bold py-2 rounded-lg text-xs">Ajouter au Staff</button>
                    <hr>
                    <p class="text-[10px] font-bold text-gray-500 uppercase">Assigner Serveur √† Table</p>
                    <div class="flex gap-2">
                        <select id="select-staff" class="flex-1 p-2 border rounded-lg text-xs"></select>
                        <select id="select-table-assign" class="flex-1 p-2 border rounded-lg text-xs">
                            <option value="">Table...</option>
                            <script>for(let i=1;i<=11;i++) document.write(`<option value="${i}">Table ${i}</option>`)</script>
                        </select>
                    </div>
                    <button onclick="assignerServeur()" class="w-full bg-slate-800 text-white font-bold py-2 rounded-lg text-xs">Valider Affectation</button>
                </div>
            </div>

            <div class="mb-4 p-4 bg-green-50 rounded-2xl border border-green-100 text-xs">
                <h3 class="font-black text-green-700 uppercase mb-3">üì¶ Ravitaillement</h3>
                <select id="select-produit-exist" class="w-full p-2 border rounded-lg bg-white mb-2"></select>
                <input id="qte-arrivage" type="number" placeholder="Quantit√©" class="w-full p-2 border rounded-lg mb-2">
                <button onclick="ajouterArrivage()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg">Mettre √† jour Stock</button>
            </div>

            <div id="admin-liste" class="space-y-2 border-t pt-4 text-[10px]"></div>
        </div>
    </div>

    <script>
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbzmO_OD1_INlwqZ1P-WpIMLVu2kfPnQvZYCozbK3gAJd954_ZGViAwGf0RYmKGj2qDu/exec";
        let tableActuelle = null;
        let panier = {}; 
        let charPrinter = null;
        
        // Donn√©es persistantes
        let STAFF = JSON.parse(localStorage.getItem('bar_staff')) || [];
        let AFFECTATIONS = JSON.parse(localStorage.getItem('bar_affectations')) || {}; // { tableNum: "NomServeur" }
        let MENU = JSON.parse(localStorage.getItem('bar_menu_v22')) || [];
        let ventesJour = JSON.parse(localStorage.getItem('ventes_bar_v22')) || [];

        function initApp() {
            const grid = document.getElementById('grid-tables');
            grid.innerHTML = "";
            for(let i=1; i<=11; i++) {
                let s = AFFECTATIONS[i] || "Libre";
                grid.innerHTML += `
                <button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-3 rounded-xl flex flex-col items-center">
                    <span class="font-bold text-xs">T${i}</span>
                    <span class="text-[8px] uppercase text-blue-500 font-bold">${s}</span>
                </button>`;
            }
            afficherMenu();
            majSelectStaff();
        }

        function majSelectStaff() {
            const s = document.getElementById('select-staff');
            s.innerHTML = '<option value="">Choisir Serveur...</option>';
            STAFF.forEach(name => s.innerHTML += `<option value="${name}">${name}</option>`);
        }

        function ajouterServeur() {
            let n = document.getElementById('new-serveur').value;
            if(n) { STAFF.push(n); localStorage.setItem('bar_staff', JSON.stringify(STAFF)); majSelectStaff(); document.getElementById('new-serveur').value = ""; }
        }

        function assignerServeur() {
            let s = document.getElementById('select-staff').value;
            let t = document.getElementById('select-table-assign').value;
            if(s && t) {
                AFFECTATIONS[t] = s;
                localStorage.setItem('bar_affectations', JSON.stringify(AFFECTATIONS));
                initApp();
                alert(`${s} est maintenant sur la Table ${t}`);
            }
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
            document.getElementById('label-serveur-table').innerText = "Serveur : " + (AFFECTATIONS[num] || "Non d√©fini");
            document.getElementById('label-num-table').innerText = "Table : " + num;
            document.getElementById('filtre-produit').focus();
        }

        function afficherMenu() {
            const container = document.getElementById('container-articles');
            const selectExist = document.getElementById('select-produit-exist');
            container.innerHTML = ""; 
            selectExist.innerHTML = '<option value="">Choisir Boisson...</option>';
            MENU.sort((a,b) => a.nom.localeCompare(b.nom)).forEach((item, index) => {
                const epuise = item.stock <= 0;
                container.innerHTML += `
                    <button data-nom="${item.nom.toLowerCase()}" onclick="${epuise ? '' : `ajouterItem('${item.nom}', ${item.prix})`}" class="item-bouton w-full ${epuise ? 'bg-gray-200 opacity-50' : 'bg-white'} border-2 p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="text-left font-bold text-slate-700">${item.nom} <span class="text-[10px] text-gray-400 font-normal ml-2">Stock: ${item.stock}</span></div>
                        <span class="font-black ${epuise ? 'text-gray-400' : 'text-blue-700'}">${item.prix}F</span>
                    </button>`;
                selectExist.innerHTML += `<option value="${index}">${item.nom}</option>`;
            });
        }

        function filtrerMenu() {
            const s = document.getElementById('filtre-produit').value.toLowerCase();
            const b = document.getElementsByClassName('item-bouton');
            for (let i = 0; i < b.length; i++) {
                b[i].style.display = b[i].getAttribute('data-nom').includes(s) ? "flex" : "none";
            }
        }

        function ajouterItem(nom, prix) {
            const item = MENU.find(m => m.nom === nom);
            const qteAuPanier = panier[nom] ? panier[nom].qte : 0;
            if(item.stock > qteAuPanier) {
                if(panier[nom]) panier[nom].qte++; else panier[nom] = {prix, qte: 1};
                majPanierUI();
                document.getElementById('filtre-produit').value = ""; filtrerMenu();
            } else { alert("Stock insuffisant !"); }
        }

        function majPanierUI() {
            const liste = document.getElementById('panier-liste');
            liste.innerHTML = ""; let t = 0;
            for (let [nom, d] of Object.entries(panier)) {
                let st = d.prix * d.qte; t += st;
                liste.innerHTML += `<div class="flex justify-between py-1 border-b border-dashed"><span>${nom} x${d.qte}</span><span>${st} F</span></div>`;
            }
            document.getElementById('total-prix').innerText = t + " F";
            document.getElementById('footer-panier').classList.toggle('translate-y-full', t === 0);
        }

        function viderCommande() { panier = {}; majPanierUI(); }
        function ouvrirAdmin() { document.getElementById('modal-admin').classList.remove('hidden'); }
        function fermerAdmin() { document.getElementById('modal-admin').classList.add('hidden'); }

        function ajouterArrivage() {
            const idx = document.getElementById('select-produit-exist').value;
            const qte = parseInt(document.getElementById('qte-arrivage').value);
            if(idx !== "" && !isNaN(qte)) { 
                MENU[idx].stock += qte; 
                localStorage.setItem('bar_menu_v22', JSON.stringify(MENU));
                document.getElementById('qte-arrivage').value = "";
                afficherMenu(); alert("Stock OK !");
            }
        }

        async function encaisserEtImprimer() {
            const btn = document.getElementById('btn-encaisser');
            const serveur = AFFECTATIONS[tableActuelle] || "Inconnu";
            try {
                if (!charPrinter) {
                    const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb'] });
                    const serverConn = await device.gatt.connect();
                    const services = await serverConn.getPrimaryServices();
                    charPrinter = (await services[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
                }

                btn.innerText = "ENVOI CLOUD..."; btn.disabled = true;

                for (let [nom, d] of Object.entries(panier)) {
                    fetch(GOOGLE_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ 
                            table: tableActuelle, 
                            produit: nom, 
                            prix: d.prix * d.qte,
                            serveur: serveur // Envoi du nom du serveur au Cloud
                        })
                    });
                    MENU.find(m => m.nom === nom).stock -= d.qte;
                    for(let i=0; i<d.qte; i++) ventesJour.push({nom, prix: d.prix, serveur: serveur});
                }
                localStorage.setItem('bar_menu_v22', JSON.stringify(MENU));
                localStorage.setItem('ventes_bar_v22', JSON.stringify(ventesJour));

                const enc = new TextEncoder();
                const sleep = ms => new Promise(r => setTimeout(r, ms));
                await charPrinter.writeValue(new Uint8Array([0x1B, 0x40]));

                let lignes = ["\n      *** RECU BAR ***\n", `TABLE : ${tableActuelle}\n`, `SERVEUR : ${serveur}\n`, `HEURE : ${new Date().toLocaleTimeString()}\n`, "--------------------------------\n"];
                let total = 0;
                for (let [nom, d] of Object.entries(panier)) {
                    let st = d.prix * d.qte; total += st;
                    let l = nom + " x" + d.qte;
                    lignes.push(l + ".".repeat(Math.max(1, 32 - l.length - (st+"F").length)) + st + "F\n");
                }
                lignes.push("--------------------------------\nTOTAL: " + total + " FCFA\n\n\n\n\n\n");

                for (let ligne of lignes) {
                    await charPrinter.writeValue(enc.encode(ligne));
                    await sleep(50);
                }

                viderCommande(); afficherMenu();
                btn.innerText = "üñ®Ô∏è VALIDER VENTE"; btn.disabled = false;
            } catch (e) { btn.innerText = "üñ®Ô∏è VALIDER VENTE"; btn.disabled = false; charPrinter = null; alert(e); }
        }

        function ouvrirRapport() {
            let t = 0; ventesJour.forEach(v => t += v.prix);
            alert("TOTAL VENTES: " + t + " F");
        }
        initApp();
    </script>
</body>
</html>
