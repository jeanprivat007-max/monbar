<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Pro - Gestion & Quantit√©s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; }
        #log { background: #000; color: #00ff00; font-family: monospace; font-size: 10px; padding: 8px; border-radius: 8px; height: 50px; overflow-y: auto; margin-bottom: 10px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="font-bold text-lg">GESTION BAR  by DEBORDO</h1>
                <div id="status" class="text-[10px] text-orange-400 font-bold uppercase italic font-mono">Pr√™t</div>
            </div>
            <button onclick="ouvrirRapport()" class="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold">üìä CAISSE</button>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-48">
        <div id="log">Console: Pr√™t...</div>

        <div class="grid grid-cols-3 gap-3 mb-6" id="grid-tables"></div>

        <div id="section-menu" class="hidden">
            <h2 id="title-commande" class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-600 pl-3 uppercase">Table</h2>
            
            <div class="space-y-3">
                <button onclick="ajouterItem('Guiness', 1000)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700">Guinness</span>
                    <span class="text-blue-700 font-black">1000F</span>
                </button>
                <button onclick="ajouterItem('Bock 66', 600)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700">Bock 66</span>
                    <span class="text-blue-700 font-black">600F</span>
                </button>
                <button onclick="ajouterItem('Demi Poulet Soupe', 2500)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700 text-left">Poulet Soupe</span>
                    <span class="text-orange-600 font-black">2500F</span>
                </button>
            </div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto">
            <div id="panier-liste" class="mb-4 text-sm font-bold text-gray-600 max-h-32 overflow-y-auto"></div>
            
            <div class="flex justify-between items-end mb-4">
                <span class="text-gray-400 font-bold uppercase text-[10px]">Total √† payer</span>
                <span id="total-prix" class="text-4xl font-black text-red-600">0 F</span>
            </div>
            
            <div class="flex gap-2">
                <button onclick="viderCommande()" class="bg-gray-100 text-gray-400 px-4 py-4 rounded-xl font-bold uppercase text-[10px]">Vider</button>
                <button onclick="encaisserEtImprimer()" class="flex-1 bg-green-600 text-white font-black py-4 rounded-xl shadow-lg text-lg active:bg-green-700">
                    üñ®Ô∏è IMPRIMER (T<span id="label-table">0</span>)
                </button>
            </div>
        </div>
    </div>

    <script>
        let tableActuelle = null;
        let panier = {}; // Format: { "Guiness": {prix: 1000, qte: 2} }
        let totalTotal = 0;
        let charPrinter = null;
        let ventesJour = JSON.parse(localStorage.getItem('bar_ventes_v5')) || [];

        function logger(msg) { document.getElementById('log').innerHTML = "> " + msg + "<br>" + document.getElementById('log').innerHTML; }

        for(let i=1; i<=6; i++) {
            document.getElementById('grid-tables').innerHTML += `<button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-4 rounded-xl font-black text-slate-400">T${i}</button>`;
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
            document.getElementById('title-commande').innerText = "Table " + num;
            document.getElementById('label-table').innerText = num;
        }

        function ajouterItem(nom, prix) {
            if (panier[nom]) {
                panier[nom].qte++;
            } else {
                panier[nom] = { prix: prix, qte: 1 };
            }
            majPanierUI();
        }

        function majPanierUI() {
            const liste = document.getElementById('panier-liste');
            liste.innerHTML = "";
            totalTotal = 0;
            
            for (let [nom, details] of Object.entries(panier)) {
                totalTotal += (details.prix * details.qte);
                liste.innerHTML += `<div class="flex justify-between border-b py-1">
                    <span>${nom} <span class="text-blue-600">x${details.qte}</span></span>
                    <span>${(details.prix * details.qte)} F</span>
                </div>`;
            }
            
            document.getElementById('total-prix').innerText = totalTotal + " F";
            document.getElementById('footer-panier').classList.toggle('translate-y-full', totalTotal === 0);
        }

        function viderCommande() {
            panier = {}; totalTotal = 0; majPanierUI();
        }

        async function encaisserEtImprimer() {
            try {
                if (!charPrinter) {
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb']
                    });
                    const server = await device.gatt.connect();
                    const services = await server.getPrimaryServices();
                    const chars = await services[0].getCharacteristics();
                    charPrinter = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);
                    document.getElementById('status').innerText = "‚úÖ CONNECT√â";
                }

                let t = "\n      --- RECU BAR  TIK TOK---\n";
                t += "DATE: " + new Date().toLocaleTimeString() + "\n";
                t += "TABLE: " + tableActuelle + "\n";
                t += "--------------------------------\n";
                t += "ART.        QTE   PRIX   TOTAL\n";
                
                for (let [nom, d] of Object.entries(panier)) {
                    let totalItem = d.prix * d.qte;
                    let line = nom.substring(0,10).padEnd(11) + 
                               d.qte.toString().padEnd(5) + 
                               totalItem.toString().padStart(8) + "F\n";
                    t += line;
                    // Sauvegarde pour le rapport
                    for(let i=0; i<d.qte; i++) ventesJour.push({nom, prix: d.prix});
                }
                
                t += "--------------------------------\n";
                t += "TOTAL: " + totalTotal.toString().padStart(18) + " FCFA\n\n\n\n";

                await charPrinter.writeValue(new Uint8Array([0x1B, 0x40]));
                await charPrinter.writeValue(new TextEncoder().encode(t));
                await charPrinter.writeValue(new Uint8Array([0x0A, 0x0A, 0x0A]));

                localStorage.setItem('bar_ventes_v5', JSON.stringify(ventesJour));
                logger("‚úÖ Imprim√© !");
                viderCommande();
            } catch (e) { logger("Erreur: " + e); charPrinter = null; }
        }

        // Fonctions Rapport (Identiques mais avec v5)
        function ouvrirRapport() { 
            /* ... (code rapport comme pr√©c√©demment) ... */ 
            alert("Ventes totales: " + ventesJour.length + " articles."); // Simplifi√© pour l'exemple
        }
    </script>
</body>
</html>
