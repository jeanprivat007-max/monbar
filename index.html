<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Pro - Nouvelle Imprimante</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; }
        #log { background: #000; color: #00ff00; font-family: monospace; font-size: 10px; padding: 8px; border-radius: 8px; height: 60px; overflow-y: auto; margin-bottom: 10px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="font-bold text-lg">GESTION BAR</h1>
                <div id="status" class="text-[10px] text-orange-400 font-bold uppercase italic">Imprimante non pr√™te</div>
            </div>
            <button onclick="ouvrirRapport()" class="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold border border-slate-500">üìä CAISSE</button>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-40">
        <div id="log">Console: Pr√™t pour nouvelle imprimante...</div>

        <div class="grid grid-cols-3 gap-3 mb-8" id="grid-tables"></div>

        <div id="section-menu" class="hidden animate-pulse-once">
            <h2 id="title-commande" class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-600 pl-3">Table</h2>
            <div class="space-y-3">
                <button onclick="ajouterItem('Guiness', 1000)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700 text-lg">Guinness</span>
                    <span class="text-blue-700 font-black text-lg">1000F</span>
                </button>
                <button onclick="ajouterItem('Bock 66', 600)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700 text-lg">Bock 66</span>
                    <span class="text-blue-700 font-black text-lg">600F</span>
                </button>
                <button onclick="ajouterItem('Demi Poulet Soupe', 2500)" class="w-full bg-white border-2 p-5 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition-transform">
                    <span class="font-bold text-slate-700 text-lg">Poulet Soupe</span>
                    <span class="text-orange-600 font-black text-lg">2500F</span>
                </button>
            </div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-10px_20px_rgba(0,0,0,0.1)] translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto flex flex-col gap-3">
            <div class="flex justify-between items-end">
                <span class="text-gray-400 font-bold uppercase text-xs">Total √† encaisser</span>
                <span id="total-prix" class="text-4xl font-black text-red-600">0 F</span>
            </div>
            <button id="btn-print" onclick="encaisserEtImprimer()" class="w-full bg-green-600 text-white font-black py-5 rounded-2xl shadow-lg text-xl active:bg-green-700">
                üñ®Ô∏è IMPRIMER TICKET
            </button>
            <button onclick="viderCommande()" class="text-gray-400 text-xs font-bold uppercase tracking-widest">Annuler la saisie</button>
        </div>
    </div>

    <div id="modal-rapport" class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8">
            <h2 class="text-2xl font-black mb-2 text-slate-900">RECETTE</h2>
            <div id="rapport-total" class="text-4xl font-black text-blue-600 mb-6 border-b pb-4">0 F</div>
            <div id="rapport-details" class="space-y-3 mb-8 font-bold text-slate-600"></div>
            <button onclick="fermerRapport()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold mb-4">Fermer</button>
            <button onclick="reinitialiserCaisse()" class="w-full text-red-500 text-[10px] font-black uppercase italic tracking-widest">Remise √† z√©ro totale</button>
        </div>
    </div>

    <script>
        let tableActuelle = null;
        let panier = [];
        let totalTotal = 0;
        let devicePrinter = null;
        let charPrinter = null;
        let ventesJour = JSON.parse(localStorage.getItem('bar_ventes_v4')) || [];

        function logger(msg) { document.getElementById('log').innerHTML = "> " + msg + "<br>" + document.getElementById('log').innerHTML; }

        // G√©n√©ration des 6 tables
        for(let i=1; i<=6; i++) {
            document.getElementById('grid-tables').innerHTML += `<button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-5 rounded-2xl font-black text-slate-400 shadow-sm transition-all active:scale-90">T${i}</button>`;
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
            document.getElementById('title-commande').innerText = "Table " + num;
        }

        function ajouterItem(nom, prix) {
            panier.push({nom, prix});
            totalTotal += prix;
            document.getElementById('footer-panier').classList.remove('translate-y-full');
            document.getElementById('total-prix').innerText = totalTotal + " F";
        }

        function viderCommande() {
            panier = []; totalTotal = 0;
            document.getElementById('footer-panier').classList.add('translate-y-full');
        }

        async function encaisserEtImprimer() {
            try {
                if (!charPrinter) {
                    logger("Recherche d'imprimante...");
                    // On accepte TOUT pour trouver la nouvelle imprimante facilement
                    devicePrinter = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb', '49535343-fe7d-4158-cd41-88a01f3a0370']
                    });
                    
                    logger("Connexion √† " + devicePrinter.name);
                    const server = await devicePrinter.gatt.connect();
                    
                    // On cherche le premier service disponible
                    const services = await server.getPrimaryServices();
                    const service = services[0];
                    const chars = await service.getCharacteristics();
                    // On prend la premi√®re caract√©ristique qui permet d'√©crire
                    charPrinter = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);
                    
                    document.getElementById('status').innerText = "‚úÖ " + devicePrinter.name;
                    document.getElementById('status').className = "text-[10px] text-green-500 font-bold uppercase";
                }

                logger("Impression en cours...");
                const init = new Uint8Array([0x1B, 0x40]);
                const feed = new Uint8Array([0x0A, 0x0A, 0x0A, 0x0A]);
                
                let t = "\n      --- MON BAR ---\n";
                t += "DATE: " + new Date().toLocaleTimeString() + "\n";
                t += "TABLE: " + tableActuelle + "\n";
                t += "--------------------------------\n";
                panier.forEach(it => {
                    let line = it.nom.substring(0,18);
                    t += line + " ".repeat(32 - line.length - it.prix.toString().length - 1) + it.prix + "F\n";
                });
                t += "--------------------------------\n";
                t += "TOTAL ENCAISSE: " + totalTotal + " F\n\n\n";

                await charPrinter.writeValue(init);
                await charPrinter.writeValue(new TextEncoder().encode(t));
                await charPrinter.writeValue(feed);

                ventesJour.push(...panier);
                localStorage.setItem('bar_ventes_v4', JSON.stringify(ventesJour));
                
                logger("‚úÖ Re√ßu imprim√© !");
                viderCommande();
            } catch (e) {
                logger("Erreur: " + e);
                charPrinter = null;
            }
        }

        function ouvrirRapport() {
            let total = 0; let s = {};
            ventesJour.forEach(v => { total += v.prix; s[v.nom] = (s[v.nom] || 0) + 1; });
            document.getElementById('rapport-total').innerText = total.toLocaleString() + " F";
            let h = ""; for (let [k, v] of Object.entries(s)) { h += `<div class="flex justify-between border-b pb-2"><span>${k}</span><span>x${v}</span></div>`; }
            document.getElementById('rapport-details').innerHTML = h;
            document.getElementById('modal-rapport').classList.remove('hidden');
        }
        function fermerRapport() { document.getElementById('modal-rapport').classList.add('hidden'); }
        function reinitialiserCaisse() { if(confirm("Vider la caisse du jour ?")) { ventesJour = []; localStorage.removeItem('bar_ventes_v4'); fermerRapport(); } }
    </script>
</body>
</html>