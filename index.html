<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar PALAUH V27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-selected { background-color: #ef4444 !important; color: white; border-color: #b91c1c; transform: scale(0.95); }
        .modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .btn-dispo { border-left: 8px solid #22c55e; }
        .btn-critique { border-left: 8px solid #f97316; }
        .btn-vide { border-left: 8px solid #ef4444; opacity: 0.5; background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg leading-none uppercase">PALAUH BAR <span class="text-yellow-400 text-xs ml-1">V27</span></h1>
                <div class="text-[9px] text-slate-400 mt-1 font-mono">STOCK INITIALIS√â √Ä 20</div>
            </div>
            <div class="flex gap-2">
                <button onclick="ouvrirAdmin()" class="bg-slate-700 p-2 rounded-lg text-sm font-bold">‚öôÔ∏è</button>
                <button onclick="ouvrirRapport()" class="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold">üìä CAISSE</button>
            </div>
        </div>
    </nav>

    <main class="max-w-lg mx-auto p-4 pb-48">
        <div class="grid grid-cols-3 gap-2 mb-6" id="grid-tables"></div>
        <div id="section-menu" class="hidden">
            <div class="relative mb-4">
                <input type="text" id="filtre-produit" onkeyup="filtrerMenu()" placeholder="Rechercher une boisson..." 
                    class="w-full p-4 pl-12 rounded-2xl border-2 border-slate-200 shadow-sm outline-none focus:border-blue-500">
                <span class="absolute left-4 top-4 text-gray-400">üîç</span>
            </div>
            <div id="container-articles" class="grid gap-3"></div>
        </div>
    </main>

    <div id="footer-panier" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl translate-y-full transition-transform z-40">
        <div class="max-w-lg mx-auto">
            <div id="panier-liste" class="mb-4 text-sm font-bold max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-xl border"></div>
            <div class="flex justify-between items-center mb-4 border-t pt-2">
                <span class="text-gray-500 font-bold text-xs uppercase">Total :</span>
                <span id="total-prix" class="text-3xl font-black text-red-600">0 F</span>
            </div>
            <button id="btn-encaisser" onclick="encaisserEtImprimer()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg text-lg uppercase">üñ®Ô∏è Valider & Imprimer</button>
        </div>
    </div>

    <div id="modal-admin" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-black">Stock</h2>
                <button onclick="fermerAdmin()" class="text-2xl">&times;</button>
            </div>
            <div id="admin-liste" class="space-y-1 text-[10px] uppercase font-bold"></div>
        </div>
    </div>

    <script>
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbzmO_OD1_INlwqZ1P-WpIMLVu2kfPnQvZYCozbK3gAJd954_ZGViAwGf0RYmKGj2qDu/exec";
        let tableActuelle = null;
        let panier = {}; 
        let charPrinter = null;
        let AFFECTATIONS = JSON.parse(localStorage.getItem('bar_affectations')) || {};
        let ventesJour = JSON.parse(localStorage.getItem('ventes_bar_v27')) || [];

        const PRODUITS_BASE = [
            { nom: "Bock 66", prix: 600 }, { nom: "Desperados", prix: 700 },
            { nom: "Valpierre Petit", prix: 1000 }, { nom: "Valpierre Grand", prix: 2000 },
            { nom: "Guiness Petit", prix: 700 }, { nom: "Guiness Grand", prix: 1200 },
            { nom: "Beaufort Petit", prix: 600 }, { nom: "Beaufort Grand", prix: 700 },
            { nom: "Racines", prix: 500 }, { nom: "Sombreros", prix: 600 },
            { nom: "Coco Cola", prix: 500 }, { nom: "Fanta", prix: 500 },
            { nom: "Sweppes Agrumes", prix: 500 }, { nom: "Sweppes Tonic", prix: 500 },
            { nom: "Youzou", prix: 500 }, { nom: "Ivoire Black", prix: 500 },
            { nom: "Ivoire Bleu", prix: 500 }, { nom: "Heineken", prix: 700 },
            { nom: "Vin Chamberry", prix: 2000 }, { nom: "Vin saint jean", prix: 2000 },
            { nom: "Bar Bock 66", prix: 800 }, { nom: "Bar Desperados", prix: 900 },
            { nom: "Bar Valpierre Petit", prix: 1200 }, { nom: "Bar Valpierre Grand", prix: 2200 },
            { nom: "Bar Guiness Petit", prix: 1000 }, { nom: "Bar Guiness Grand", prix: 1400 },
            { nom: "Bar Beaufort Petit", prix: 800 }, { nom: "Bar Beaufort Grand", prix: 900 },
            { nom: "Bar Racines", prix: 700 }, { nom: "Bar Sombreros", prix: 800 },
            { nom: "Bar Coco Cola", prix: 700 }, { nom: "Bar Fanta", prix: 700 },
            { nom: "Bar Sweppes Agrumes", prix: 700 }, { nom: "Bar Sweppes Tonic", prix: 700 },
            { nom: "Bar Youzou", prix: 700 }, { nom: "Bar Ivoire Black", prix: 700 },
            { nom: "Bar Ivoire Bleu", prix: 700 }, { nom: "Bar Heineken", prix: 900 },
            { nom: "Bar Vin Chamberry", prix: 2200 }, { nom: "Bar Vin saint jean", prix: 2200 }
        ];

        const KITS = [
            { nom: "Kit Guiness", prix: 2500, compo: { cible: "Guiness Petit", qte: 3 } },
            { nom: "Kit Beaufort", prix: 2500, compo: { cible: "Beaufort Petit", qte: 3 } },
            { nom: "Kit Desperados", prix: 2500, compo: { cible: "Desperados", qte: 3 } },
            { nom: "Bar Kit Guiness", prix: 3000, compo: { cible: "Bar Guiness Petit", qte: 3 } },
            { nom: "Bar Kit Beaufort", prix: 2500, compo: { cible: "Bar Beaufort Petit", qte: 3 } },
            { nom: "Bar Kit Desperados", prix: 2500, compo: { cible: "Bar Desperados", qte: 3 } }
        ];

        let MENU = JSON.parse(localStorage.getItem('bar_menu_v27')) || [
            ...PRODUITS_BASE.map(p => ({...p, stock: 20})),
            ...KITS
        ];

        function initApp() {
            const grid = document.getElementById('grid-tables'); grid.innerHTML = "";
            for(let i=1; i<=11; i++) {
                let s = AFFECTATIONS[i] || "Libre";
                grid.innerHTML += `<button onclick="choisirTable(${i})" id="btn-t-${i}" class="bg-white border-2 border-slate-200 py-3 rounded-xl flex flex-col items-center"><span class="font-bold text-xs">T${i}</span><span class="text-[8px] uppercase text-blue-600 font-black truncate w-full px-1">${s}</span></button>`;
            }
            afficherMenu();
        }

        function afficherMenu() {
            const container = document.getElementById('container-articles');
            const adminListe = document.getElementById('admin-liste');
            container.innerHTML = ""; adminListe.innerHTML = "";
            MENU.sort((a,b) => a.nom.localeCompare(b.nom)).forEach((item) => {
                let s = item.stock; if(item.compo) { let src = MENU.find(m => m.nom === item.compo.cible); s = Math.floor(src.stock / item.compo.qte); }
                let col = s <= 0 ? "btn-vide" : (s < 5 ? "btn-critique" : "btn-dispo");
                container.innerHTML += `<button data-nom="${item.nom.toLowerCase()}" onclick="${s <= 0 ? '' : `ajouterItem('${item.nom}', ${item.prix})`}" class="item-bouton w-full bg-white border-2 p-4 rounded-xl flex justify-between items-center shadow-sm ${col}"><div class="text-left font-bold text-slate-700">${item.nom} <span class="text-[10px] text-gray-400 font-normal ml-2">S: ${s}</span></div><span class="font-black ${s <= 0 ? 'text-gray-400' : 'text-blue-700'}">${item.prix}F</span></button>`;
                if(!item.compo) adminListe.innerHTML += `<div class="flex justify-between border-b py-1"><span>${item.nom}</span><span>Stock: ${item.stock}</span></div>`;
            });
        }

        function filtrerMenu() {
            const s = document.getElementById('filtre-produit').value.toLowerCase();
            const b = document.getElementsByClassName('item-bouton');
            for (let i = 0; i < b.length; i++) { b[i].style.display = b[i].getAttribute('data-nom').includes(s) ? "flex" : "none"; }
        }

        function choisirTable(num) {
            tableActuelle = num;
            document.querySelectorAll('#grid-tables button').forEach(b => b.classList.remove('table-selected'));
            document.getElementById('btn-t-'+num).classList.add('table-selected');
            document.getElementById('section-menu').classList.remove('hidden');
        }

        function ajouterItem(nom, prix) {
            const item = MENU.find(m => m.nom === nom);
            let s = item.stock; if(item.compo) { let src = MENU.find(m => m.nom === item.compo.cible); s = Math.floor(src.stock / item.compo.qte); }
            const q = panier[nom] ? panier[nom].qte : 0;
            if(s > q) { if(panier[nom]) panier[nom].qte++; else panier[nom] = {prix, qte: 1}; majPanierUI(); }
        }

        function retirerUn(nom) { if(panier[nom]) { panier[nom].qte--; if(panier[nom].qte <= 0) delete panier[nom]; majPanierUI(); } }

        function majPanierUI() {
            const liste = document.getElementById('panier-liste'); liste.innerHTML = ""; let t = 0;
            for (let [nom, d] of Object.entries(panier)) {
                let st = d.prix * d.qte; t += st;
                liste.innerHTML += `<div class="flex justify-between items-center py-2 border-b"><span class="font-bold text-slate-700 text-xs">${nom}</span><div class="flex items-center gap-2"><button onclick="retirerUn('${nom}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold">-</button><span class="w-4 text-center">${d.qte}</span><button onclick="ajouterItem('${nom}', ${d.prix})" class="bg-green-100 text-green-600 px-3 py-1 rounded-lg font-bold">+</button><span class="ml-2 font-black">${st}F</span></div></div>`;
            }
            document.getElementById('total-prix').innerText = t + " F";
            document.getElementById('footer-panier').classList.toggle('translate-y-full', t === 0);
        }

        async function encaisserEtImprimer() {
            const btn = document.getElementById('btn-encaisser'); const serveur = AFFECTATIONS[tableActuelle] || "Caissi√®re";
            try {
                if (!charPrinter) {
                    const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb'] });
                    const serverConn = await device.gatt.connect();
                    const services = await serverConn.getPrimaryServices();
                    charPrinter = (await services[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
                }
                btn.innerText = "ENVOI..."; btn.disabled = true;
                for (let [nom, d] of Object.entries(panier)) {
                    const item = MENU.find(m => m.nom === nom);
                    if(item.compo) { MENU.find(m => m.nom === item.compo.cible).stock -= (item.compo.qte * d.qte); } else { item.stock -= d.qte; }
                    fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ table: tableActuelle, produit: nom, prix: d.prix * d.qte, serveur: serveur }) });
                    for(let i=0; i<d.qte; i++) ventesJour.push({nom, prix: d.prix, serveur, table: tableActuelle});
                }
                localStorage.setItem('bar_menu_v27', JSON.stringify(MENU));
                localStorage.setItem('ventes_bar_v27', JSON.stringify(ventesJour));
                const enc = new TextEncoder();
                let t = "\n      *** PALAUH BAR ***\n" + `TABLE : ${tableActuelle}\n` + "--------------------------------\n";
                for (let [nom, d] of Object.entries(panier)) { t += nom + " x" + d.qte + " : " + (d.prix*d.qte) + "F\n"; }
                t += "--------------------------------\nTOTAL: " + document.getElementById('total-prix').innerText + "\n\n\n\n\n\n";
                for (let i = 0; i < t.length; i += 20) { await charPrinter.writeValue(enc.encode(t.substring(i, i + 20))); await new Promise(r => setTimeout(r, 40)); }
                panier = {}; majPanierUI(); afficherMenu(); btn.innerText = "Valider & Imprimer"; btn.disabled = false;
            } catch (e) { btn.disabled = false; charPrinter = null; alert(e); }
        }

        function ouvrirRapport() { let t = 0; ventesJour.forEach(v => t += v.prix); if(confirm(`CAISSE : ${t} F\nCl√¥turer la journ√©e ?`)) { ventesJour = []; localStorage.setItem('ventes_bar_v27', JSON.stringify(ventesJour)); alert("RAZ OK"); } }
        function ouvrirAdmin() { document.getElementById('modal-admin').classList.remove('hidden'); }
        function fermerAdmin() { document.getElementById('modal-admin').classList.add('hidden'); }
        initApp();
    </script>
</body>
</html>
